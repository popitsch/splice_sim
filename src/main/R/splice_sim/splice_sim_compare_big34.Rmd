---
title: "splice_sim_compare_big34.Rmd"
author: "niko.popitsch@imba.oeaw.ac.at"
documentclass: article
fontsize: 10pt
output:
  html_document:
    toc: true
    toc_float: true
    fig_width: 14
    fig_height: 10
    fig_caption: true
    df_print: paged
  pdf_document:
    fig_width: 12
    fig_height: 10
    fig_caption: true
params:
    big3_meta_file:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/splice_sim_paper/replicate_data_big3_kss/meta.rds"
    big3_data_file:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/splice_sim_paper/replicate_data_big3_kss/data.pooled.rds"
    big4_data_file:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/splice_sim_paper/replicate_data_kss/data.pooled.rds"
    out_dir:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/splice_sim_paper/analysis_kss/"
---
<style type="text/css">
body, td {
   font-size: 10px;
}
code.r{
  font-size: 10px;
}
pre {
  font-size: 10px
}
div.blue pre { background-color:lightblue; }
div.blue pre.r { background-color:blue; }
</style>

<!--
rmarkdown::render('splice_sim_big34.Rmd', 'html_document')
-->

# INIT

```{r setup, include=FALSE}
require(data.table)
require(tidyr)
require(dplyr)
require(ggplot2)
require(scales)
require(rjson)
require(stringr)
require(VGAM)
require(cowplot)
require(arrow)
require(tictoc)
require(ggpubr)
require(minpack.lm)
require(readr)
require(testthat)
require(RColorBrewer)
require(skimr)
require(ggforce)
require(writexl)
require(xfun)
require(forcats)
require(glue)
# NB install arrow with snappy on Rstudio server
# Sys.setenv(ARROW_WITH_SNAPPY = "ON")
# Sys.setenv(NOT_CRAN="true")
# Sys.setenv(LIBARROW_BINARY="FALSE")
# install.packages("arrow", repos = "https://arrow-r-nightly.s3.amazonaws.com")

# to ensure stripping '\0' (nul) from character vector
options(arrow.skip_nul = TRUE)

# global theme
ggplot2::theme_set(theme_light())

# enable tidylog (has overhead!)
#require(tidylog)
# turn tidylog off
options("tidylog.display" = list()) 

# load resources/functions
source('splice_sim_resources.R')

```


# data

```{r data, include=F, echo=F, cache=T, eval=F}

# create result dir?
if (!dir.exists(params$out_dir)) {
  dir.create(params$out_dir)
} 
if (!dir.exists(paste0(params$out_dir,'/cache/'))) {
  dir.create(paste0(params$out_dir,'/cache/'))
} 


#home_dir='/Users/niko.popitsch/Desktop/data/projects/Ameres/splicing/splice_sim/testruns/big4_slamseq_nf/'


# meta file
m3=readRDS(params$big3_meta_file)

# shortcuts
tx3 = readRDS(params$big3_data_file)[['tx']] %>% mutate(dataset='m_small')
all_tids=unique(tx3 %>% pull(fid))
tx4 = dr[['tx']] %>% filter(rep=='rep1', fid %in% all_tids) %>% mutate(dataset='m_big')


```


## compare big3 / big4 tx


<div class = "blue">
<b>Comparison between big3 and big4.</b>
A) Boxplots of transcript F1 values show reduced F1 in big4 compared to big3. 
This analysis incorporated all tx simulated in big3 tx. Note that in big4, however, we simulated many more tx (basically one tx for every gene) that contribute FPs to the analysed transcripts.
B) Comparing TP, FP and FN values between shows the increased FP rates in big4 stemming from tx not simulated in big3. 
C+D) Effect on F1 and recall correlations between these datasets.
</div>

```{r big34, include=T, echo=F, cache=T}

perf_tx34_corr = tx3 %>% 
  bind_rows(tx4) %>% 
  select(fid, mapper, conversion_rate, true_isoform, dataset, F1=all_F1, recall=all_recall, TP=all_TP, FP=all_FP, FN=all_FN) %>% 
  pivot_wider(names_from=dataset, values_from = c(F1, recall, TP, FP, FN)) %>% 
  mutate(F1_diff=F1_m_small-F1_m_big)


# p1 = perf_tx34 %>% 
#   ggplot(aes(dataset, F1, fill=dataset)) + 
#   geom_boxplot() +
#   facet_grid(mapper~.) +
#   xlab("Dataset")

p1 = perf_tx34_corr %>% 
  group_by(mapper) %>% 
  pivot_longer(c(F1_m_small, F1_m_big)) %>% 
  ggplot(aes(name, value, fill=name)) + 
  geom_boxplot() +
  facet_wrap(mapper~., scales = 'free', nrow=1) + 
  ylab("") + xlab("") + theme(legend.position="none") 

p2.1=plot_grid(plotlist=list(
      perf_tx34_corr %>% 
      plot_corr( 'TP_m_small', 'TP_m_big', 'mapper', main_title='TP ', max_x=NA, xlog=F, show_legend=F, calc_corr=F, draw_diag = T ) +
      my_scales() + facet_grid(mapper~.) + xlab("m_small") + ylab("m_big") + theme(axis.text.x=element_text(size=rel(0.7)))
      ,
      perf_tx34_corr %>% 
      plot_corr( 'FN_m_small', 'FN_m_big', 'mapper', main_title='FN', max_x=NA, xlog=F, show_legend=F, calc_corr=F, draw_diag = T ) +
      my_scales() + facet_grid(mapper~.) + xlab("m_small") + ylab("m_big") + theme(axis.text.x=element_text(size=rel(0.7)))
      ), nrow=1)
p2.2=perf_tx34_corr %>% 
    plot_corr( 'FP_m_small', 'FP_m_big', 'mapper', main_title='FP', max_x=NA, xlog=F, show_legend=F, calc_corr=F, draw_diag = T ) +
    my_scales() + facet_grid(mapper~conversion_rate) + xlab("m_small") + ylab("m_big") + theme(axis.text.x=element_text(size=rel(0.7)))
p2 = plot_grid(p2.1, p2.2, ncol=1)

p3 = perf_tx34_corr %>% 
  plot_corr( 'F1_m_small', 'F1_m_big', 'mapper', main_title='F1', max_x=NA, xlog=F, show_legend=F, calc_corr=T, draw_diag = T ) +
  my_scales() +
  facet_grid(mapper~conversion_rate) + xlab("m_small") + ylab("m_big") + theme(axis.text.x=element_text(size=rel(0.7)))

p4 = perf_tx34_corr %>% 
  plot_corr( 'recall_m_small', 'recall_m_big', 'mapper', main_title='Recall', max_x=NA, xlog=F, show_legend=F, calc_corr=T, draw_diag = T ) +
  my_scales() +
  facet_grid(mapper~conversion_rate) + xlab("m_small") + ylab("m_big") + theme(axis.text.x=element_text(size=rel(0.7)))

my_plot_grid(list(p1,p2,p3,p4), 'Comparison of tx scores between m_small and m_big', labels = T)
ggsave(paste0(params$out_dir, 'compare_F1_big34.pdf'), width=14, height=10)

```