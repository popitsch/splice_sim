---
title: "splice_sim_decay_analysis.Rmd"
author: "niko.popitsch@imba.oeaw.ac.at"
documentclass: article
fontsize: 10pt
output:
  pdf_document:
    fig_width: 12
    fig_height: 10
    fig_caption: true
  html_document:
    toc: true
    toc_float: true
    fig_width: 14
    fig_height: 10
    fig_caption: true
    df_print: paged
params:
    decay_config_tx:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/testruns/decay_sim_nf4_kss/config.json"
    decay_config_intron:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/testruns/decay_sim_nf4_intron_kss/config.json"
    decay_fcounts_tx:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/testruns/decay_sim_nf4_kss/slamstr/fcounts/"
    decay_fcounts_intron:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/testruns/decay_sim_nf4_intron_kss/slamstr/fcounts/"
    
    out_dir:
       value: "/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/splice_sim_paper/analysis_kss/"
---
<style type="text/css">
body, td {
   font-size: 10px;
}
code.r{
  font-size: 10px;
}
pre {
  font-size: 10px
}
div.blue pre { background-color:lightblue; }
div.blue pre.r { background-color:blue; }
</style>

<!--
rmarkdown::render('splice_sim_decay_analysis.Rmd', 'html_document')
-->

# INIT

```{r setup, include=FALSE}
require(data.table)
require(tibble)
require(tidyr)
require(dplyr)
require(ggplot2)
require(scales)
require(rjson)
require(stringr)
require(VGAM)
require(cowplot)
require(arrow)
require(tictoc)
require(ggpubr)
require(rstatix)
require(minpack.lm)
require(readr)
require(testthat)
require(RColorBrewer)
require(skimr)
require(ggforce)
require(writexl)
require(xfun)
require(forcats)
# NB install arrow with snappy on Rstudio server
# Sys.setenv(ARROW_WITH_SNAPPY = "ON")
# Sys.setenv(NOT_CRAN="true")
# Sys.setenv(LIBARROW_BINARY="FALSE")
# install.packages("arrow", repos = "https://arrow-r-nightly.s3.amazonaws.com")

# to ensure stripping '\0' (nul) from character vector
options(arrow.skip_nul = TRUE)

# global theme
ggplot2::theme_set(theme_light())

# enable tidylog (has overhead!)
#require(tidylog)
# turn tidylog off
options("tidylog.display" = list()) 

# load resources/functions
source('splice_sim_resources.R')
```


# data

```{r data, include=F, echo=F, cache=T, eval=F}

# create result dir?
if (!dir.exists(params$out_dir)) {
  dir.create(params$out_dir)
} 

# ===========================================================
# load decay experiment data
# ===========================================================

create_fcr_table_tx_OLD_DELME = function(config_file, diff_perc=0.1) {
  decay_conf=fromJSON(paste(readLines(config_file), collapse=""))
  decay_home_dir=paste0(dirname(config_file),'/')
  # load simulated data
  decay_d=list()
  decay_m=list()
  decay_g=list()
  for ( tp in decay_conf$timepoints) {
    decay_m[[paste0('tp', tp)]] = readRDS(paste0(decay_home_dir,'tp',tp,'/eva/results/meta.rds'))[['tx']]
    decay_d[[paste0('tp', tp)]] = readRDS(paste0(decay_home_dir,'tp',tp,'/eva/results/data.rds'))[['tx']]
    decay_g[[paste0('tp', tp)]] = readRDS(paste0(decay_home_dir,'tp',tp,'/eva/results/meta.rds'))[['ga']]
  }

  # We will consider only these tids in the analysis
  all_tids=decay_m[['tp0']] %>% filter(len>100) %>% pull(tid) %>% unique()

  # calculate theoretical truth data
  decay_isoform_truth = load_table(paste0(decay_home_dir, decay_conf$isoform_config)) %>% 
    rename(fid=transcript_id) %>% 
    filter(fid %in% !!all_tids) %>%  # remove tids w/o mappings
    filter(!is.na(fid) ) %>% # remove fids w/o mappings (should be none)
    as_tibble()
  truth = tibble()
  for ( tp in decay_conf$timepoints ) {
    truth = truth %>% rbind(
      decay_isoform_truth %>% mutate(tp=!!tp, ftc=exp(!!tp * -k), hl=log(2)/k) %>% mutate(mapper='truth')
    )
  }
  
  # load slamstr counts and calculate simulated + mapper derived FCR
  fcr_slamstr=tibble()
  for ( tp in decay_conf$timepoints) {
    for (m in c('truth', 'STAR.final', 'HISAT3N.final')) {
      fcr_slamstr=fcr_slamstr %>% rbind(
        load_table(paste0(decay_home_dir, '/slamstr/counts/', decay_conf$dataset_name, '_tp',tp,'.cr0.05.',m,'.counts.tsv.gz')) %>% 
          filter(feature_id %in% !!all_tids)  %>% 
          mutate(tp=!!tp, mapper=!!m) %>% 
          mutate(mapper=case_when(
            mapper=='STAR.final'~'STAR',
            mapper=='HISAT3N.final'~'HISAT3N',
            mapper=='truth'~'simulated',
            T ~ 'NA')) %>% 
          mutate(ftc=tc_reads/all_reads, tp=!!tp) %>% 
          select(fid = feature_id, tp, ftc, mapper) %>% 
          left_join(decay_isoform_truth, by='fid')
      )
    }
  }
  
  # calculate true simulated FCR
  # complete set of id/mapper to avoid missing values
  fcr_sim_true = list()
  for ( tp in decay_conf$timepoints ) {
    tp = paste0('tp',tp)
    # to avoid missing values for some tids we join with 'all_data'
    fcr_sim_true[[tp]] = expand_grid(fid = all_tids,  mapper= c('STAR')) %>% 
      left_join(decay_d[[tp]] %>% 
                  filter(conversion_rate==0.05, mapper=='STAR') %>% # use only the labeled reads and consider only STAR entries here as we only need truth data
                  select(-conversion_rate),
                  by=c('fid', 'mapper')) %>% 
      mutate(across(where(is.numeric), ~ifelse(is.nan(.) | is.na(.), 0, .))) %>%    
      group_by(fid, mapper, classification) %>% # summarise over true_isoform
      summarise(all=sum(count), 
                tc1=sum(count[cv1==1]), 
                tc2=sum(count[cv2==1])) %>% 
      pivot_wider(names_from=classification, values_from=c(all, tc1, tc2), names_sort=T) %>% 
      mutate(across(where(is.numeric), ~ifelse(is.nan(.) | is.na(.), 0, .))) %>% 
      mutate(
        all_true =  all_TP+all_FN,
        tc1_true =  tc1_TP+tc1_FN,
        tc2_true =  tc2_TP+tc2_FN,
        true_fcr1 = ifelse(all_true>0,tc1_true/all_true,0),
        true_fcr2 = ifelse(all_true>0,tc2_true/all_true,0),
    ) 
  }  
  fcr_sim_true = bind_rows(fcr_sim_true, .id = 'tp') %>% 
    mutate(tp=as.numeric(substr(tp,3, nchar(tp)))) %>% 
    left_join(decay_m[['tp0']], by=c('fid'='tid')) %>% # any tp will work here
    ungroup()
  fcr_sim_true = fcr_sim_true %>% 
    select(mapper, tp, fid, mappability,true_fcr1) %>% 
    group_by(fid,tp) %>% 
    pivot_wider(names_from=mapper, values_from=c(true_fcr1)) %>% 
    mutate(across(where(is.numeric), ~ifelse(is.nan(.) | is.na(.), 0, .))) %>%   # replace NA with 0; NA are resulting from mat not having introns. So if there are no FP values then there are no entries!
    rename(simulated_true=STAR) %>%
    pivot_longer(c('simulated_true'), names_to='mapper', values_to='ftc') %>% 
    select(fid, tp, ftc, mapper) %>% 
    left_join(decay_isoform_truth, by='fid') %>% 
    ungroup()  
  
  
  # combine all data to one table
  fcr = fcr_sim_true %>%
    bind_rows(truth %>% select(fid,tp,ftc,mapper,rnk,mappability,k,decay_rate)) %>%
    bind_rows(fcr_slamstr %>% select(fid,tp,ftc,mapper,rnk,mappability,k,decay_rate)) %>%
    mutate(k=factor(k),
          decay_rate=case_when(k==0.05 ~ 'slow',
                              k==0.1 ~'moderate',
                              k==0.15 ~ 'fast',
                              T~NA_character_))
  
  # normalize ftc to 1st timepoint because we do not correct using ZIB here
  fcr = fcr %>% 
    group_by(mapper, fid) %>% mutate(ftc_max=max(ftc)) %>% ungroup() %>% 
    left_join(fcr %>% filter(tp==0) %>% select(fid, mapper, ftc0=ftc), by=c('fid','mapper')) %>% 
    mutate(ftc_norm_tp0=ifelse(ftc0>0,ftc/ftc0,NA),
           ftc_norm_max=ifelse(ftc_max>0,ftc/ftc_max,NA)) %>% 
    mutate(mapper=factor(mapper, levels=c('truth', 'simulated_true', 'simulated', 'HISAT3N', 'STAR'))) %>% 
    mutate(mappability=factor(mappability, levels=c('high', 'medium', 'low')))

  # calculate half-life
  decay_halflifes = fcr %>% 
    select(fid, mapper, mappability, decay_rate, tp, ftc_norm_max) %>% 
    mutate(tp = paste0('tp',tp)) %>% 
    group_by(fid, mapper, mappability, decay_rate) %>% 
    pivot_wider(names_from = tp, values_from = ftc_norm_max ) %>% 
    rowwise() %>% 
    mutate(hl=fit_halflife(
      c(0,5,10,15,20,25), c(tp0,tp5,tp10,tp15,tp20,tp25))[['hl']]) %>% 
    mutate(mappability=factor(mappability, levels=c('high', 'medium', 'low'))) %>% 
    ungroup()

  # add outlier detection
  hlcorr=decay_halflifes %>% 
    pivot_wider(names_from = mapper, values_from = hl, 
                id_cols = c('fid', 'mappability', 'decay_rate')) %>% 
    mutate(STAR_outlier=ifelse(STAR<simulated*(1.0-!!diff_perc) | STAR > simulated*(1.0+!!diff_perc),'outlier','no_outlier'),
           HISAT3N_outlier=ifelse(HISAT3N<simulated*(1.0-!!diff_perc) | HISAT3N > simulated*(1.0+!!diff_perc),'outlier','no_outlier')) %>% 
    mutate(cat=case_when(
        STAR_outlier=='outlier' & HISAT3N_outlier == 'outlier' ~ 'Both',
        STAR_outlier=='no_outlier' & HISAT3N_outlier=='outlier' ~ 'HISAT3N',
        STAR_outlier=='outlier' & HISAT3N_outlier=='no_outlier' ~ 'STAR',
        STAR_outlier=='no_outlier' & HISAT3N_outlier=='no_outlier' ~ 'No Outlier',
        TRUE ~ NA_character_
    ) ) %>% left_join(decay_g[['tp0']], by=c('fid'='tid')) %>% 
    ungroup()

  return( list(fcr=fcr, decay_halflifes=decay_halflifes, hlcorr=hlcorr, 
               truth=truth, anno= decay_m[['tp0']] ))
}

create_fcr_table_tx = function(config_file, fcounts_dir, diff_perc=0.1) {
  decay_conf=fromJSON(paste(readLines(config_file), collapse=""))
  decay_home_dir=paste0(dirname(config_file),'/')
  
    
  # load annotations
  anno = readRDS(paste0(decay_home_dir,'tp0/eva/results/meta.rds'))[['tx']] %>% 
    left_join( readRDS(paste0(decay_home_dir,'tp0/eva/results/meta.rds'))[['ga']], by='tid') %>% 
    left_join( load_table(paste0(decay_home_dir, decay_conf$isoform_config)) %>% select(-c(mappability, rnk)), by=c('tid'='transcript_id'))
  
  # We will consider only these tids in the analysis
  all_tids=anno %>% filter(len>100) %>% pull(tid) %>% unique()
  
  # load fcounts and calc fcr
  fcounts = load_table(paste0(fcounts_dir, '/feature_counts.tsv.gz')) %>% 
    rename(tid=Geneid) %>% 
    filter(tid %in% !!all_tids)  %>% # filter for lenth
    select(-c(Chr,Start,End,Strand,Length)) %>% pivot_longer(-c(tid), names_to='bam', values_to = 'count') %>% 
    left_join(
      load_table(paste0(fcounts_dir, '/sample_sheet.tsv')), by='bam'
    ) %>% select(-bam) %>% 
    group_by(tid, tp, mapper, filtered) %>% 
    pivot_wider(names_from = type, values_from = count) %>% 
    ungroup() %>% 
    mutate(ftc=tc/all) %>% 
    mutate(mapper=case_when(
      mapper=='HISAT3N' & filtered==1 ~ 'HISAT3N_filtered',
      mapper=='STAR' & filtered==1 ~ 'STAR_filtered',
      TRUE ~ mapper
    )) %>% select(-c(all, tc, filtered))
  
  # calc truth (configured data)
  truth = expand_grid(tid = all_tids,  mapper= c('truth'), tp=decay_conf$timepoints) %>% 
    left_join(anno %>% select(tid, k), by='tid') %>% 
    mutate(ftc=exp(tp * -k), hl=log(2)/k) %>% 
    select(tid,tp,mapper,ftc)
    
  # Complete FCR table
  fcr=fcounts %>% bind_rows(truth) %>% 
    group_by(tid, mapper) %>% 
    mutate(ftc_max=max(ftc)) %>% ungroup() %>% 
    mutate(ftc_norm_max=ifelse(ftc_max>0,ftc/ftc_max,NA)) %>% 
    mutate(mapper=factor(mapper, levels=c('truth', 'simulated', 'HISAT3N','HISAT3N_filtered', 'STAR', 'STAR_filtered'))) %>% 
    left_join(anno %>% select(tid, decay_rate, mappability), by='tid')

  # calculate half-life
  decay_halflifes = fcr %>% 
    select(-c(ftc, ftc_max)) %>% 
    mutate(tp = paste0('tp',tp)) %>% 
    group_by(tid, mapper, mappability, decay_rate) %>% 
    pivot_wider(names_from = tp, values_from = ftc_norm_max ) %>% 
    rowwise() %>% 
    mutate(hl=fit_halflife(
      c(0,5,10,15,20,25), c(tp0,tp5,tp10,tp15,tp20,tp25))[['hl']]) %>% 
    mutate(mappability=factor(mappability, levels=c('high', 'medium', 'low'))) %>% 
    ungroup()

  
  # add outlier detection
  hlcorr=decay_halflifes %>%
    select(tid, mapper, decay_rate, mappability, hl) %>% 
    #left_join(truth %>% filter(tp==0) %>% select(fid, tid), by='fid') %>% 
    pivot_wider(names_from = mapper, values_from = hl, 
                id_cols = c('tid', 'mappability', 'decay_rate', 'mappability')) %>% 
    mutate(STAR_outlier=ifelse(STAR<simulated*(1.0-!!diff_perc) | STAR > simulated*(1.0+!!diff_perc),'outlier','no_outlier'),
           HISAT3N_outlier=ifelse(HISAT3N<simulated*(1.0-!!diff_perc) | HISAT3N > simulated*(1.0+!!diff_perc),'outlier','no_outlier'),
           STAR_filtered_outlier=ifelse(STAR_filtered<simulated*(1.0-!!diff_perc) | STAR_filtered > simulated*(1.0+!!diff_perc),'outlier','no_outlier'),
           HISAT3N_filtered_outlier=ifelse(HISAT3N_filtered<simulated*(1.0-!!diff_perc) | HISAT3N_filtered > simulated*(1.0+!!diff_perc),'outlier','no_outlier')) %>% 
    mutate(cat=case_when(
        STAR_outlier=='outlier' & HISAT3N_outlier == 'outlier' ~ 'Both',
        STAR_outlier=='no_outlier' & HISAT3N_outlier=='outlier' ~ 'HISAT3N',
        STAR_outlier=='outlier' & HISAT3N_outlier=='no_outlier' ~ 'STAR',
        STAR_outlier=='no_outlier' & HISAT3N_outlier=='no_outlier' ~ 'No Outlier',
        TRUE ~ NA_character_
    ) ) %>% left_join(anno %>% select(tid, gene_type), by='tid') %>% 
    ungroup()

  return( list(fcr=fcr, decay_halflifes=decay_halflifes, hlcorr=hlcorr, 
               truth=truth, anno=anno ))
}


# =======================================================

create_fcr_table_in = function(config_file, fcounts_dir, diff_perc=0.1) {
  decay_conf=fromJSON(paste(readLines(config_file), collapse=""))
  decay_home_dir=paste0(dirname(config_file),'/')
  
    
  # load annotations
  anno = readRDS(paste0(decay_home_dir,'tp0/eva/results/meta.rds'))[['fx']]  %>% filter(ftype=='intron') %>% 
    rename(exon_num=rnk) %>% 
    left_join( readRDS(paste0(decay_home_dir,'tp0/eva/results/meta.rds'))[['ga']], by='tid') %>% 
    left_join( load_table(paste0(decay_home_dir, decay_conf$isoform_config)) %>% select(-c(mappability, frac_mature)), by=c('tid'='transcript_id'))
  
  # We will consider only these tids in the analysis
  all_fids=anno %>% filter(len>100) %>% pull(fid) %>% unique()
  
  # load fcounts and calc fcr
  fcounts = load_table(paste0(fcounts_dir, '/feature_counts.tsv.gz')) %>% 
    rename(fid=Geneid) %>% 
    separate(fid, into = c(NA,'fid1','fid2'), sep = ':') %>% 
    mutate(fid=paste0(fid1,'_in',fid2)) %>% 
    select(-c(fid1,fid2)) %>% 
    filter(fid %in% !!all_fids)  %>% # filter for lenth
    select(-c(Chr,Start,End,Strand,Length)) %>% pivot_longer(-c(fid), names_to='bam', values_to = 'count') %>% 
    left_join(
      load_table(paste0(fcounts_dir, '/sample_sheet.tsv')), by='bam'
    ) %>% select(-bam) %>% 
    group_by(fid, tp, mapper, filtered) %>% 
    pivot_wider(names_from = type, values_from = count) %>% 
    ungroup() %>% 
    mutate(ftc=tc/all) %>% 
    mutate(mapper=case_when(
      mapper=='HISAT3N' & filtered==1 ~ 'HISAT3N_filtered',
      mapper=='STAR' & filtered==1 ~ 'STAR_filtered',
      TRUE ~ mapper
    )) %>% select(-c(all, tc, filtered))
  
  # calc truth (configured data)
  truth = expand_grid(fid = all_fids,  mapper= c('truth'), tp=decay_conf$timepoints) %>% 
    left_join(anno %>% select(fid, k), by='fid') %>% 
    mutate(ftc=exp(tp * -k), hl=log(2)/k) %>% 
    select(fid,tp,mapper,ftc)
    
  # Complete FCR table
  fcr=fcounts %>% bind_rows(truth) %>% 
    group_by(fid, mapper) %>% 
    mutate(ftc_max=max(ftc)) %>% ungroup() %>% 
    mutate(ftc_norm_max=ifelse(ftc_max>0,ftc/ftc_max,NA)) %>% 
    mutate(mapper=factor(mapper, levels=c('truth', 'simulated', 'HISAT3N','HISAT3N_filtered', 'STAR', 'STAR_filtered'))) %>% 
    left_join(anno %>% select(fid, decay_rate, mappability), by='fid')

  # calculate half-life
  decay_halflifes = fcr %>% 
    select(-c(ftc, ftc_max)) %>% 
    mutate(tp = paste0('tp',tp)) %>% 
    group_by(fid, mapper, mappability, decay_rate) %>% 
    pivot_wider(names_from = tp, values_from = ftc_norm_max ) %>% 
    rowwise() %>% 
    mutate(hl=fit_halflife(
      c(0,5,10,15,20,25), c(tp0,tp5,tp10,tp15,tp20,tp25))[['hl']]) %>% 
    mutate(mappability=factor(mappability, levels=c('high', 'medium', 'low'))) %>% 
    ungroup()

  
  # add outlier detection
  hlcorr=decay_halflifes %>%
    select(fid, mapper, decay_rate, mappability, hl) %>% 
    #left_join(truth %>% filter(tp==0) %>% select(fid, tid), by='fid') %>% 
    pivot_wider(names_from = mapper, values_from = hl, 
                id_cols = c('fid', 'mappability', 'decay_rate', 'mappability')) %>% 
    mutate(STAR_outlier=ifelse(STAR<simulated*(1.0-!!diff_perc) | STAR > simulated*(1.0+!!diff_perc),'outlier','no_outlier'),
           HISAT3N_outlier=ifelse(HISAT3N<simulated*(1.0-!!diff_perc) | HISAT3N > simulated*(1.0+!!diff_perc),'outlier','no_outlier'),
           STAR_filtered_outlier=ifelse(STAR_filtered<simulated*(1.0-!!diff_perc) | STAR_filtered > simulated*(1.0+!!diff_perc),'outlier','no_outlier'),
           HISAT3N_filtered_outlier=ifelse(HISAT3N_filtered<simulated*(1.0-!!diff_perc) | HISAT3N_filtered > simulated*(1.0+!!diff_perc),'outlier','no_outlier')) %>% 
    mutate(cat=case_when(
        STAR_outlier=='outlier' & HISAT3N_outlier == 'outlier' ~ 'Both',
        STAR_outlier=='no_outlier' & HISAT3N_outlier=='outlier' ~ 'HISAT3N',
        STAR_outlier=='outlier' & HISAT3N_outlier=='no_outlier' ~ 'STAR',
        STAR_outlier=='no_outlier' & HISAT3N_outlier=='no_outlier' ~ 'No Outlier',
        TRUE ~ NA_character_
    ) ) %>% left_join(anno %>% select(fid, gene_type), by='fid') %>% 
    ungroup()

  return( list(fcr=fcr, decay_halflifes=decay_halflifes, hlcorr=hlcorr, 
               truth=truth, anno=anno ))
}




```

```{r}
# TX

#prepare experiment (needs m from main Rmd!)
# loads tx set as created by splice_sim_celltype_mappability.Rmd
#
# set.seed(123)
# isoform_config = load_table('/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/testruns/ref/mESC_expressed_tx_ribozero.tsv') %>%
#   left_join(m[['tx']] %>% select(tid, rnk, mappability), by=c('transcript_id'='tid')) %>%
#   mutate(k = replicate(n(),sample(c(0.05, 0.1, 0.15),1,replace = TRUE))) %>%
#   mutate(k=factor(k),
#          decay_rate=case_when(k==0.05 ~ 'slow',
#                               k==0.1 ~'moderate',
#                               k==0.15 ~ 'fast',
#                               T~'NA')
#   ) %>% as_tibble()
# isoform_config %>% write_tsv('/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/testruns/decay_sim_nf4_kss/isoform_config.tsv')


# INTRONS

# prepare experiment
# set.seed(123)
# isoform_config = load_table('/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/testruns/ref/mESC_expressed_tx_ribozero.tsv') %>%
#   left_join(m[['tx']] %>% select(tid, rnk, mappability), by=c('transcript_id'='tid')) %>%
#   mutate(k = replicate(n(),sample(c(0.05, 0.1, 0.15),1,replace = TRUE))) %>%
#   mutate(frac_mature = 0) %>%
#   mutate(k=factor(k),
#          decay_rate=case_when(k==0.05 ~ 'slow',
#                               k==0.1 ~'moderate',
#                               k==0.15 ~ 'fast',
#                               T~'NA')
#   ) %>% as_tibble()
# isoform_config %>% write_tsv('/groups/ameres/Niko/projects/Ameres/splicing/splice_sim/testruns/decay_sim_nf4_intron_kss/isoform_config.tsv')

```


# Tx decay

```{r}
fcr_tx = create_fcr_table_tx(params$decay_config_tx, params$decay_fcounts_tx)
```

## QC: overlapping annotations
```{r}
# correlate simulated (true) values with slamstr derived values from simulated alignment
comp = 
  fcr_tx$fcr %>% filter(mapper %in% c('STAR', 'STAR_filtered')) %>% 
  select(tid, tp, ftc,mapper) %>% 
  pivot_wider(names_from = mapper, values_from = ftc) %>% 
  left_join(fcr_tx$anno, by='tid')%>% 
  ungroup() 
comp %>% mutate(is_overlapping=overlapping_tids!='') %>% 
  ggplot(aes(STAR, STAR_filtered, col=is_overlapping)) + geom_point() +
  facet_wrap(tp~.) +
  ggtitle("Errors introduced by overlapping annotations")


# which tids were outliers and were 'rescued' by filtering
rescued_tids=c( fcr_tx$hlcorr %>% filter(STAR_outlier=='outlier', STAR_filtered_outlier=='no_outlier') %>% pull(tid),
                fcr_tx$hlcorr %>% filter(HISAT3N_outlier=='outlier', HISAT3N_filtered_outlier=='no_outlier') %>% pull(tid) ) %>% unique()
rescued_tids %>% length()

fcr_tx$decay_halflifes %>% 
  filter(tid %in% rescued_tids) %>% 
  ggplot(aes(x=decay_rate, y=hl, col=mapper)) + 
  geom_boxplot() +
  stat_summary(fun.data = function(x){return(c(y=0,label=length(na.omit(x))))}, 
               geom = "text", position = position_dodge(width = 0.75), size=2.5) +
  my_scales() +
  scale_y_sqrt() + ylab("halflife") + xlab("Decay rate") +
  ggtitle("Reconstructed halflifes")


# one nice exmaple could be Tpt1 (ENSMUST00000110894.8) chr14:75,843,256-75,850,303
# it is an outlier in both mappers (unfiltered) and none in both filtered versions
# fcr seems to be overestimated by mmany fp reads at low-mappability exons. 
# are TC reads actually falsely mapped"?
fcr_tx$fcr %>%
  filter(tid=='ENSMUST00000110894.8') %>% 
  ggplot(aes(x=tp, y=ftc_norm_max, col=decay_rate, group=paste0( tid, mappability,mapper))) + 
  geom_line(alpha=0.3) +
  facet_wrap(mappability~mapper) +
  geom_hline(yintercept = 0.5, col='grey', linetype='dotted') +
  facet_grid(mappability~mapper) +
  ylab("FCR, normalized to maximum") +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "genomic mappability", 
                      breaks = NULL, labels = NULL)) +
  theme(legend.position="none", axis.title.y.right = element_text(angle=-90, vjust = 1.5)) +
  my_scales() +
  ggtitle("FCR decay curves") +
  xlab("timepoint")
  
```

## Tx halflife analysis

<div class = "blue">
<b>Effect of NC mappability on transcript halflife calculations.</b>
A) Normalized mature transcript FCR per timepoint for true, simulated and mapped data. 
The truth data models an idealized exponential decay curve (FCR~e^(t * -k)) for three randomly assigned decay rates (violet: fast/k=0.15, brown: moderate/k=0.1, magenta: slow/k=0.05). 
FCR was normalized to the maximum value across all timepoints and halflifes were determined by fitting the exponential decay model to these data in R. 
The data reconstructed from the read mapper alignments show increasing noise with decreasing genomic mappability although some clear outliers are also visible in high  mappability regions.
This plot includes only mature transcripts with length>100; the grey, dashed line indicated 50% FCR.

B) Reconstructed halflifes. Median halflife for the considered genes is slightly over-/underestimated for fast and slow genes respectively (cf. also panels C+D). The boxplot also shows a considerable number of outliers for both mappers. The number of considered transcripts is plotted below the boxes.
Note that estimated halflifes from simulated data is systematically higher than the true value. This is because in this analysis, as in a true world scenario,only reads with at least one 
found NC were considered to be converted, excluding the considerable number of reads from the 'true' converted set that have zero conversions just by chance. Although we could have 
corrected for this in our simulated data (as we know the origin of each individual read), we decided to treat simulated and mapped data the same way to keep them comparable.

C+D) Correlation between estimated halflifes from simulated data and STAR respectively HISAT3N alignments with highlighted outlier.
Transcripts with a >10% difference between reconstructed halflifes from simulated and mapped data were considered as outliers (red, triangles).
The theoretical true halflife for the three decay rate categories is indicated by the red dashed lines. 
Pearson and Spearman correlation coefficients are slightly higher for STAR, however halflifes for less tx could be reconstructed when compared to HISAT3N.

E) Outlier counts per category. While most outliers are shared by the two mappers, there is a considerable amount that originates 
only from one of the two alignments.

F) Gene types of outliers (in one or both mappers), colored by mappability. 
</div>

```{r}

p1 = fcr_tx$fcr %>%
  ggplot(aes(x=tp, y=ftc_norm_max, col=decay_rate, group=paste0( tid, mappability,mapper))) + 
  geom_line(alpha=0.3) +
  facet_wrap(mappability~mapper) +
  geom_hline(yintercept = 0.5, col='grey', linetype='dotted') +
  facet_grid(mappability~mapper) +
  ylab("FCR, normalized to maximum") +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "genomic mappability", 
                      breaks = NULL, labels = NULL)) +
  theme(legend.position="none", axis.title.y.right = element_text(angle=-90, vjust = 1.5)) +
  my_scales() +
  ggtitle("FCR decay curves") +
  xlab("timepoint")
  
  
p2 = fcr_tx$decay_halflifes %>% 
  ggplot(aes(x=decay_rate, y=hl, col=mapper)) + 
  geom_boxplot() +
  stat_summary(fun.data = function(x){return(c(y=0,label=length(na.omit(x))))}, 
               geom = "text", position = position_dodge(width = 0.75), size=2.5) +
  my_scales() +
  scale_y_sqrt() + ylab("halflife") + xlab("Decay rate") +
  ggtitle("Reconstructed halflifes")

p3 = plot_corr( fcr_tx$hlcorr, 'simulated', 'STAR', 'STAR_outlier', shape='STAR_outlier', main_title='STAR', max_x=NA, xlog=T, show_legend=F ) +
  my_scales() +
  geom_vline(xintercept = unique(fcr_tx$truth$hl), col='red', linetype='dotted') +
  xlab("Simulated halflife") + ylab("STAR halflife")

p4 = plot_corr( fcr_tx$hlcorr, 'simulated', 'HISAT3N', 'HISAT3N_outlier', shape='HISAT3N_outlier', main_title='HISAT3N', max_x=NA, xlog=T, show_legend=F ) +
  my_scales() +
  geom_vline(xintercept = unique(fcr_tx$truth$hl), col='red', linetype='dotted') +
  xlab("Simulated halflife") + ylab("HISAT3N halflife")

p5 = fcr_tx$hlcorr %>% group_by(mappability) %>% count(cat=cat) %>% 
  mutate(cat=factor(cat), cat=fct_reorder(cat, n, .desc=T)) %>% 
  ggplot(aes(cat, n, fill=mappability)) + geom_col() + xlab("") +
  ylab("# Transcripts") +
  xlab("Outlier in ...") +
  my_scales() +
  coord_flip() 

out_tids = fcr_tx$hlcorr %>% filter(!is.na(cat) & cat!='No Outlier') %>% pull(tid)
p6 = fcr_tx$hlcorr %>% 
  filter(tid %in% !!out_tids) %>% 
  mutate(gene_type_cat=gene_type2cat(gene_type)) %>% 
  group_by(gene_type_cat) %>% 
  mutate(ncat=n()) %>% 
  group_by(mappability, gene_type_cat, ncat) %>% 
  count(gene_type_cat) %>% 
  ungroup() %>% 
  mutate(gene_type_cat=factor(gene_type_cat), gene_type_cat=fct_reorder(gene_type_cat, ncat)) %>% 
  ggplot(aes(gene_type_cat, n, fill=mappability)) +
  geom_col() +
  #scale_y_sqrt() +
  coord_flip() +
  my_scales() +
  xlab("") + ylab("# Outliers") +
  theme(legend.position="none")

p7 = fcr_tx$anno %>% as_tibble() %>%  group_by(ftype) %>% count(mappability) %>% 
  rename(genomic_mappability=mappability) %>% 
  mutate(ftype=factor(ftype, levels=c('tx', 'exon', 'intron'))) %>% 
  ggplot(aes(genomic_mappability, n, fill=genomic_mappability)) +
  geom_col(position=position_dodge()) +
  xlab("Genomic Mappability") + ylab("") + my_scales() + facet_wrap(.~ftype, scales = 'free') + 
  theme(legend.position="none") +
  ylab("# Transcripts") +
  my_scales()


upper=plot_grid(p1,p2,p3,p4, labels = c('A','B','C','D'), nrow = 2)
lower=plot_grid(p5,p6,p7, labels = c('E','F','G'), nrow = 1, rel_widths = c(1,1.2,0.6))
my_plot_grid(list(upper, lower),  'Tx halflife reconstruction performance', ncol = 1, rel_heights = c(2,1))
ggsave(paste0(params$out_dir, 'special_decay_tx.pdf'), width=12, height=10)

```


# Intron decay

```{r}
fcr_in = create_fcr_table_in(params$decay_config_intron, params$decay_fcounts_intron)
```


## Intron halflife analysis

<div class = "blue">
<b>Effect of NC mappability on intron halflife calculations.</b>
Panels A-F analoguous to Fig XX. Overall, intron halflife reconstruction seems more robust to outliers when compared to transcripts. 
Note, however, that considered introns are considerable longer and have higher mappability when compared to exonic transcript regions.
This plot includes only introns with length>100
</div>

```{r}
# plot halflifes
p1 = fcr_in$fcr %>% 
      ggplot(aes(x=tp, y=ftc_norm_max, col=decay_rate, group=paste0( fid, mappability,mapper))) + 
      geom_line(alpha=0.3) +
      facet_wrap(mappability~mapper) +
      geom_hline(yintercept = 0.5, col='grey', linetype='dotted') +
      facet_grid(mappability~mapper) +
      ylab("FCR, normalized to maximum") +
      my_scales() +
      scale_y_continuous(sec.axis = sec_axis(~ . , name = "genomic mappability", 
                          breaks = NULL, labels = NULL)) +
      theme(legend.position="none", axis.title.y.right = element_text(angle=-90, vjust = 1.5)) +
      ggtitle("FCR decay curves") +
      xlab("timepoint")
      
  
  
p2 = fcr_in$decay_halflifes %>% 
  ggplot(aes(x=decay_rate, y=hl, col=paste0(mapper, ifelse(filtered==1,'_fil','')))) + 
  geom_boxplot() +
  my_scales() +
  stat_summary(fun.data = function(x){return(c(y=0,label=length(x)))}, 
               geom = "text", position = position_dodge(width = 0.75), size=2.5) +
  scale_y_sqrt() + ylab("halflife") + xlab("Decay rate") +
  ggtitle('Reconstructed halflifes')

p3 = plot_corr( fcr_in$hlcorr, 'simulated', 'STAR', 'STAR_outlier', shape='STAR_outlier', main_title='STAR', max_x=NA, xlog=T, show_legend=F ) +
  my_scales() +
  geom_vline(xintercept = unique(fcr_in$truth$hl), col='red', linetype='dotted') +
  xlab("Simulated halflife") + ylab("STAR halflife")

p4 = plot_corr( fcr_in$hlcorr, 'simulated', 'HISAT3N', 'HISAT3N_outlier', shape='HISAT3N_outlier', main_title='HISAT3N', max_x=NA, xlog=T, show_legend=F ) +
  my_scales() +
  geom_vline(xintercept = unique(fcr_in$truth$hl), col='red', linetype='dotted') +
  xlab("Simulated halflife") + ylab("HISAT3N halflife")

p5 = fcr_in$hlcorr %>% group_by(mappability) %>% count(cat=cat) %>% 
  mutate(cat=factor(cat), cat=fct_reorder(cat, n, .desc=T)) %>% 
  ggplot(aes(cat, n, fill=mappability)) + geom_col() + xlab("") +
  ylab("# Introns") +
  xlab("Outlier in ...") +
  my_scales() +
  coord_flip() 

out_tids = fcr_in$hlcorr %>% filter(!is.na(cat) & cat!='No Outlier') %>% pull(fid)
p6 = fcr_in$hlcorr %>% 
  filter(fid %in% !!out_tids) %>% 
  mutate(gene_type_cat=gene_type2cat(gene_type)) %>% 
  group_by(gene_type_cat) %>% 
  mutate(ncat=n()) %>% 
  group_by(mappability, gene_type_cat, ncat) %>% 
  count(gene_type_cat) %>% 
  ungroup() %>% 
  mutate(gene_type_cat=factor(gene_type_cat), gene_type_cat=fct_reorder(gene_type_cat, ncat)) %>% 
  ggplot(aes(gene_type_cat, n, fill=mappability)) +
  geom_col() +
  #scale_y_sqrt() +
  coord_flip() +
  my_scales() +
  xlab("") + ylab("# Outliers") +
  theme(legend.position="none")

p7 = fcr_in$anno %>% as_tibble()%>% group_by(ftype) %>% count(mappability) %>% 
  rename(genomic_mappability=mappability) %>% 
  mutate(ftype=factor(ftype, levels=c('tx', 'exon', 'intron'))) %>% 
  ggplot(aes(genomic_mappability, n, fill=genomic_mappability)) +
  geom_col(position=position_dodge()) +
  xlab("Genomic Mappability") + ylab("# Introns") + 
  facet_wrap(.~ftype, scales = 'free') + 
  theme(legend.position="none") +
  my_scales()

upper=plot_grid(p1,p2,p3,p4, labels = c('A','B','C','D'), nrow = 2)
lower=plot_grid(p5,p6,p7, labels = c('E','F','G'), nrow = 1, rel_widths = c(1,1.2,0.6))
my_plot_grid(list(upper, lower),  'Intron halflife reconstruction performance', ncol = 1, rel_heights = c(2,1))

ggsave(paste0(params$out_dir, 'special_decay_intron.pdf'), width=12, height=10)


```
# Filter experiments

```{r}

# load filtered/unfiltered data
load_filter_data = function(filtered) {
  fil_dat = list()
  for (  mapper in c('STAR', 'HISAT3N')) { # 
    for ( tp in decay_conf_tx$timepoints ) { # 
      all_data_tx = expand_grid(fid = decay_m[['tx']][['tp0']] %>% filter(len>100) %>% pull(tid), 
                         mapper= c(mapper), filtered=c(filtered)) # complete set of id/mapper to avoid missing values 
      tab=NA
      if (filtered==1) {
       tab = load_table(paste0(params$decay_filter_experiment_folder,'/counts_filtered/decay_sim_nf4_tp',
                                 tp,'.cr0.05.',mapper,'.counts.tsv')) %>% mutate(filtered=1) %>% 
         as_tibble() %>% 
         filter(class_type=='tx')
      } else {
       tab = load_table(paste0(params$decay_filter_experiment_folder,'/counts_unfiltered/decay_sim_nf4_tp',
                                 tp,'.cr0.05.',mapper,'.counts.tsv')) %>% mutate(filtered=0) %>% 
         as_tibble() %>% 
         filter(class_type=='tx')
      }
    # to avoid missing values for some tids we join with 'all_data'
    fil_dat[[paste0('mapper',mapper,'tp',tp)]] = all_data_tx %>% 
      left_join(tab %>% 
                  filter(conversion_rate==0.05) %>% # use only the labeled reads
                  select(-conversion_rate),
                  by=c('fid', 'mapper', 'filtered')) %>% 
      mutate(across(where(is.numeric), ~ifelse(is.nan(.) | is.na(.), 0, .))) %>%    
      mutate(tp=!!tp) %>% 
      group_by(fid, tp,  mapper, classification, filtered) %>% # summarise over true_isoform
      summarise(all=sum(count), 
                tc1=sum(count[cv1==1]), 
                tc2=sum(count[cv2==1])) %>% 
      pivot_wider(names_from=classification, values_from=c(all, tc1, tc2), names_sort=T) %>% 
      mutate(across(where(is.numeric), ~ifelse(is.nan(.) | is.na(.), 0, .))) %>% 
      mutate(
        all_true =  all_TP+all_FN,
        all_found = all_TP+all_FP,
        tc1_true =  tc1_TP+tc1_FN,
        tc1_found = tc1_TP+tc1_FP,
        tc2_true =  tc2_TP+tc2_FN,
        tc2_found = tc2_TP+tc2_FP,
        true_fcr1 = ifelse(all_true>0,tc1_true/all_true,0),
        found_fcr1 = ifelse(all_found>0,tc1_found/all_found,0),
        true_fcr2 = ifelse(all_true>0,tc2_true/all_true,0),
        found_fcr2 = ifelse(all_found>0,tc2_found/all_found,0),
    ) 
    }  
  }
  fil_dat = bind_rows(fil_dat) %>% 
    ungroup() %>% 
    left_join(decay_m[['tx']][['tp0']], by=c('fid'='tid')) %>% # any tp will work here
    ungroup()
  fil_counts=fil_dat
  
  # calc fcr
  fil_dat = fil_dat %>% 
    select(filtered, mapper, tp, fid, mappability,true_fcr1, found_fcr1) %>% 
    group_by(filtered, fid, tp) %>% 
    pivot_wider(names_from=mapper, values_from=c(true_fcr1, found_fcr1)) %>% 
    mutate(across(where(is.numeric), ~ifelse(is.nan(.) | is.na(.), 0, .))) %>%   # replace NA with 0; NA are resulting from mat not having introns. So if there are no FP values then there are no entries!
    rename(simulated=true_fcr1_HISAT3N, HISAT3N=found_fcr1_HISAT3N, STAR=found_fcr1_STAR) %>%
    select(-true_fcr1_STAR) %>%
    pivot_longer(c('simulated','HISAT3N','STAR'), names_to='mapper', values_to='ftc') %>% 
    select(fid, tp, ftc, mapper) %>% 
    left_join(decay_isoform_truth_tx, by='fid') %>% 
    ungroup() 
  # add truth
  fil_dat = fil_dat %>%
    bind_rows(truth_tx %>% select(fid,tp,ftc,mapper,rnk,mappability,k,decay_rate) %>%
                add_column(filtered=0, .before='fid')) %>% # never filtered
    mutate(k=factor(k),
          decay_rate=case_when(k==0.05 ~ 'slow',
                              k==0.1 ~'moderate',
                              k==0.15 ~ 'fast',
                              T~NA_character_))
  
  
  # normalize ftc to 1st timepoint because we do not correct using ZIB here
  fil_dat = fil_dat %>% 
    group_by(filtered, mapper, fid) %>% mutate(ftc_max=max(ftc)) %>% ungroup() %>% 
    left_join(fil_dat %>% filter(tp==0) %>% select(filtered, fid, mapper, ftc0=ftc), by=c('filtered', 'fid','mapper')) %>% 
    mutate(ftc_norm_tp0=ifelse(ftc0>0,ftc/ftc0,NA),
           ftc_norm_max=ifelse(ftc_max>0,ftc/ftc_max,NA)) %>% 
    mutate(mapper=factor(mapper, levels=c('truth', 'simulated', 'HISAT3N', 'STAR'))) %>% 
    mutate(mappability=factor(mappability, levels=c('high', 'medium', 'low')))
  
  return(list('fcr'=fil_dat, 'cnt'=fil_counts))
}
  
decay_fcr_tx_filtered = load_filter_data(filtered=1)
decay_fcr_tx_unfiltered = load_filter_data(filtered=0)

# replace simulated fcr estimates in filtered dataset
decay_fcr_tx_filtered$fcr = decay_fcr_tx_filtered$fcr %>% 
  filter(mapper!='simulated') %>% 
  bind_rows(
    decay_fcr_tx_unfiltered$fcr %>% 
   filter(mapper=='simulated')
  )



# calculate half-life
decay_halflifes_tx_filtered = decay_fcr_tx_filtered$fcr %>% 
  select(filtered, fid, mapper, mappability, decay_rate, tp, ftc_norm_max) %>% 
  mutate(tp = paste0('tp',tp)) %>% 
  group_by(filtered, fid, mapper, mappability, decay_rate) %>% 
  pivot_wider(names_from = tp, values_from = ftc_norm_max ) %>% 
  rowwise() %>% 
  mutate(hl=fit_halflife(
    c(0,5,10,15,20,25), c(tp0,tp5,tp10,tp15,tp20,tp25))[['hl']]) %>% 
  mutate(mappability=factor(mappability, levels=c('high', 'medium', 'low'))) %>% 
  ungroup()

decay_halflifes_tx_unfiltered = decay_fcr_tx_unfiltered$fcr %>% 
  select(filtered, fid, mapper, mappability, decay_rate, tp, ftc_norm_max) %>% 
  mutate(tp = paste0('tp',tp)) %>% 
  group_by(filtered, fid, mapper, mappability, decay_rate) %>% 
  pivot_wider(names_from = tp, values_from = ftc_norm_max ) %>% 
  rowwise() %>% 
  mutate(hl=fit_halflife(
    c(0,5,10,15,20,25), c(tp0,tp5,tp10,tp15,tp20,tp25))[['hl']]) %>% 
  mutate(mappability=factor(mappability, levels=c('high', 'medium', 'low'))) %>% 
  ungroup()


# add outlier detection
diff_perc=0.1
hlcorr_tx_unfiltered=decay_halflifes_tx_unfiltered %>% 
  pivot_wider(names_from = mapper, values_from = hl, 
              id_cols = c('fid', 'mappability', 'decay_rate')) %>% 
  mutate(STAR_outlier=ifelse(STAR<simulated*(1.0-!!diff_perc) | STAR > simulated*(1.0+!!diff_perc),'outlier','no_outlier'),
         HISAT3N_outlier=ifelse(HISAT3N<simulated*(1.0-!!diff_perc) | HISAT3N > simulated*(1.0+!!diff_perc),'outlier','no_outlier')) %>% 
  mutate(cat=case_when(
      STAR_outlier=='outlier' & HISAT3N_outlier == 'outlier' ~ 'Both',
      STAR_outlier=='no_outlier' & HISAT3N_outlier=='outlier' ~ 'HISAT3N',
      STAR_outlier=='outlier' & HISAT3N_outlier=='no_outlier' ~ 'STAR',
      STAR_outlier=='no_outlier' & HISAT3N_outlier=='no_outlier' ~ 'No Outlier',
      TRUE ~ NA_character_
  ) ) %>% left_join(decay_g[['tx']][['tp0']], by=c('fid'='tid')) %>% 
  ungroup()

# calculate outliers in unfiltered dataset that have sufficient simulated reads (>100) in the filtered data
outliers_with_data = 
  list(
    'STAR' = tibble('fid'=hlcorr_tx_unfiltered %>% filter(STAR_outlier=='outlier') %>% pull(fid) %>% unique()),
    'HISAT3N' = tibble('fid'=hlcorr_tx_unfiltered %>% filter(HISAT3N_outlier=='outlier') %>% pull(fid) %>% unique()),
    'truth' = tibble('fid'=hlcorr_tx_unfiltered %>% pull(fid) %>% unique()),
    'simulated' = tibble('fid'=hlcorr_tx_unfiltered %>% pull(fid) %>% unique())
  ) %>% bind_rows(.id='mapper') %>% 
  left_join(decay_fcr_tx_filtered$cnt %>% select(fid, mapper, all_true) %>% 
              group_by(fid,mapper) %>% summarise(all_true=max(all_true)), by=c('fid','mapper')) %>% 
  left_join(decay_halflifes_tx_filtered %>% select(fid, mapper, hl)) %>% # filter for calculated hl
  #filter(all_true>100) %>% 
  filter(!is.na(hl)) 


# show n
print(outliers_with_data %>% group_by(mapper) %>% count())

p1 = outliers_with_data %>% left_join(decay_fcr_tx_unfiltered$fcr, by=c('fid', 'mapper')) %>%
  ggplot(aes(x=tp, y=ftc_norm_max, col=decay_rate, group=paste0( fid, mappability,mapper))) + 
  geom_line(alpha=0.3) +
  facet_wrap(mappability~mapper) +
  geom_hline(yintercept = 0.5, col='grey', linetype='dotted') +
  facet_grid(mappability~mapper) +
  ylab("FCR, normalized to maximum") +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "genomic mappability", 
                      breaks = NULL, labels = NULL)) +
  theme(legend.position="none", axis.title.y.right = element_text(angle=-90, vjust = 1.5)) +
  my_scales() +
  ggtitle("FCR decay curves (unfiltered)") +
  xlab("timepoint")

p2 = decay_halflifes_tx_unfiltered %>% 
  ggplot(aes(x=decay_rate, y=hl, col=mapper)) + 
  geom_boxplot() +
  stat_summary(fun.data = function(x){return(c(y=0,label=length(na.omit(x))))}, 
               geom = "text", position = position_dodge(width = 0.75), size=2.5) +
  my_scales() +
  scale_y_sqrt() + ylab("halflife") + xlab("Decay rate") +
  ggtitle("Reconstructed halflifes (unfiltered)") +
  coord_cartesian(ylim = c(-0, 40)) 

p3 = outliers_with_data %>% left_join(decay_fcr_tx_filtered$fcr, by=c('fid', 'mapper')) %>%
  ggplot(aes(x=tp, y=ftc_norm_max, col=decay_rate, group=paste0( fid, mappability,mapper))) + 
  geom_line(alpha=0.3) +
  facet_wrap(mappability~mapper) +
  geom_hline(yintercept = 0.5, col='grey', linetype='dotted') +
  facet_grid(mappability~mapper) +
  ylab("FCR, normalized to maximum") +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "genomic mappability", 
                      breaks = NULL, labels = NULL)) +
  theme(legend.position="none", axis.title.y.right = element_text(angle=-90, vjust = 1.5)) +
  my_scales() +
  ggtitle("FCR decay curves (filtered)") +
  xlab("timepoint") 

p4 = decay_halflifes_tx_filtered %>% 
   filter(fid %in% outliers_with_filtered_data) %>% 
  ggplot(aes(x=decay_rate, y=hl, col=mapper)) + 
  geom_boxplot() +
  stat_summary(fun.data = function(x){return(c(y=0,label=length(na.omit(x))))}, 
               geom = "text", position = position_dodge(width = 0.75), size=2.5) +
  my_scales() +
  scale_y_sqrt() + ylab("halflife") + xlab("Decay rate") +
  ggtitle("Reconstructed halflifes (filtered)") +
  coord_cartesian(ylim = c(-0, 40)) 

plot_grid(p1,p2,p3,p4, labels=c('A','B','C','D'), nrow = 2)
```
### Corr
```{r}

tab = decay_halflifes_tx_filtered %>% 
  select(fid, mapper, mappability, decay_rate,hl) %>% 
  pivot_wider(names_from = mapper, values_from = hl) %>% 
  rename(HISAT3N_filtered=HISAT3N, STAR_filtered=STAR) %>% 
  left_join(
    decay_halflifes_tx_unfiltered %>% 
    filter(mapper %in% c('STAR', 'HISAT3N')) %>% 
    select(fid,mapper,hl) %>% 
    pivot_wider(names_from = mapper, values_from = hl), by='fid'
  ) %>% mutate(is_outlier=ifelse(fid %in% outliers,1,0)) %>% 
  mutate(
    STAR_filtered_hldiff=abs(simulated-STAR_filtered),
    STAR_unfiltered_hldiff=abs(simulated-STAR),
    HISAT3N_filtered_hldiff=abs(simulated-HISAT3N_filtered),
    HISAT3N_unfiltered_hldiff=abs(simulated-HISAT3N),
    ) %>% 
  mutate(is_outlier=ifelse(is_outlier==1,'outlier','no outlier'))

p1=tab %>% plot_corr('HISAT3N', 'simulated', 'is_outlier')
p2=tab %>% plot_corr('HISAT3N_filtered', 'simulated', 'is_outlier')
p3=tab %>% plot_corr('STAR', 'simulated', 'is_outlier')
p4=tab %>% plot_corr('STAR_filtered', 'simulated', 'is_outlier')
plot_grid(p1,p2,p3,p4, labels=c('A','B','C','D'), nrow = 2)

dat= tab %>% 
  select(fid, STAR_filtered_hldiff, STAR_unfiltered_hldiff,
    HISAT3N_filtered_hldiff, HISAT3N_unfiltered_hldiff, is_outlier) %>% 
  drop_na() %>% # only complete sets
  pivot_longer(-c('fid', 'is_outlier')) %>% 
  separate(name, c('mapper','status', NA), sep='_') 

dat %>% 
  ggplot(aes(status, value, fill=status)) +
  geom_boxplot() + facet_wrap(is_outlier~mapper, scales = 'free') +
  scale_y_sqrt() +
  geom_hline(yintercept = 0, col='black', linetype='dotted') +
  stat_summary(fun.data = function(x){return(c(y=10,label=length(na.omit(x))))}, 
               geom = "text", position = position_dodge(width = 0.75), size=2.5) +
  ggtitle("Halflife difference to simulated values.", 
          "Only tx for which a hl could be calculated in all conditions") +
  ylab("Difference to simulated halflife") +
  stat_pvalue_manual(
    dat %>% 
      group_by(mapper,is_outlier) %>% 
      wilcox_test(data = ., status~value, paired=FALSE, 
                  comparisons = list(c("filtered", "unfiltered"))) %>%
      adjust_pvalue(method = "BH") %>% add_significance()  %>% add_y_position(),
    label = "p.adj.signif", bracket.nudge.y=0
  )

```

### Examples
```{r}
m[['ga']] %>% filter(tid %in% outliers_with_filtered_data) %>% filter(tid=='ENSMUST00000178147.2')

```


# _________
# Suppl Figures

## Fig S1

<div class = "blue">
<b>XXX</b>

Number of annotations with high (>0.9), low (<0.2) and medium genomic mappability.
</div>

```{r}




#my_plot_grid(list(f1a, f1b, f1c, f1d), 'Fig1', labels = T)
ggsave(paste0(params$out_dir, 'special_decay_mappability.pdf'), width=8, height=4)

```

